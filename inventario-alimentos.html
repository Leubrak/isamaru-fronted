<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventario de Alimentos - Isamaru</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --primary-color: #41D0E7; --primary-dark: #2596A8; --accent-color: #2855A8; --light-bg: #F5FCFD; }
    #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; }
    body { background: transparent !important; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .content-wrapper { position: relative; z-index: 10; }
    .navbar { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .navbar-brand span { color: #ffffff; font-weight: bold; }
    .nav-link { color: #ffffff; font-weight: 500; }
    .nav-link:hover, .nav-link.active { color: #ffffff; opacity: 0.8; }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border: none; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--primary-dark), var(--accent-color)); transform: translateY(-2px); transition: all 0.3s; }
    .card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; }
    .table thead { background-color: var(--primary-color); color: white; }
    .table tbody tr:hover { background-color: rgba(65, 208, 231, 0.05); }
    .alert-custom { position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .caducado { background-color: #f8d7da !important; color: #721c24; }
    .por-caducar { background-color: #fff3cd !important; color: #856404; }
    .loading { display: none; text-align: center; padding: 20px; }
    .loading.active { display: block; }
    .invalid-feedback { display: none; }
    .is-invalid ~ .invalid-feedback { display: block; }
  </style>
</head>
<body>

<div id="particles-js"></div>
<script>
particlesJS("particles-js", {
  "particles": { "number": { "value": 60 }, "color": { "value": "#41D0E7" }, "shape": { "type": "circle" }, "opacity": { "value": 0.5 }, "size": { "value": 3 },
    "line_linked": { "enable": true, "distance": 150, "color": "#41D0E7", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 3, "bounce": true } },
  "interactivity": { "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" } },
    "modes": { "repulse": { "distance": 100 }, "push": { "particles_nb": 4 } } }, "retina_detect": true
});
</script>

<div id="alertContainer"></div>
<div class="content-wrapper">

<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="navbar-brand" href="#"><span>ISAMARU</span></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="interfaz-principal.html"><i class="bi bi-house-door"></i> Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="perfil-usuario.html"><i class="bi bi-person-circle"></i> Perfil</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-5">
  <h2 class="mb-4 fw-bold" style="color: var(--accent-color);">Registro de Inventario de Alimentos</h2>

  <form id="inventarioForm" class="card p-4 mb-5">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label"><i class="bi bi-folder"></i> Categor√≠a</label>
        <select id="categoria" name="categoria" class="form-select" required onchange="actualizarProveedores()">
          <option value="">Seleccione una categor√≠a</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label"><i class="bi bi-building"></i> Proveedor</label>
        <select id="proveedor" name="proveedor" class="form-select" required>
          <option value="">Primero seleccione categor√≠a...</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label"><i class="bi bi-box"></i> Nombre del Producto</label>
        <input type="text" id="nombre" name="nombre" class="form-control" required pattern="^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$" title="Solo se permiten letras y espacios" placeholder="Ej: Manzanas Rojas">
        <div class="invalid-feedback">‚ùå Solo se permiten letras y espacios (sin n√∫meros ni caracteres especiales)</div>
      </div>
      <div class="col-md-3">
        <label class="form-label"><i class="bi bi-calculator"></i> Cantidad</label>
        <input type="number" id="cantidad" name="cantidad" class="form-control" min="0.01" step="0.01" required placeholder="0.00">
      </div>
      <div class="col-md-3">
        <label class="form-label"><i class="bi bi-rulers"></i> Unidad de Medida</label>
        <select id="unidad" name="unidad" class="form-select" required>
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label"><i class="bi bi-calendar-check"></i> Fecha de Recepci√≥n</label>
        <input type="date" id="fecha_recepcion" name="fecha_recepcion" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label"><i class="bi bi-calendar-x"></i> Fecha de Caducidad</label>
        <input type="date" id="fecha_caducidad" name="fecha_caducidad" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label"><i class="bi bi-upc"></i> N√∫mero de Lote</label>
        <input type="text" id="numero_lote" name="numero_lote" class="form-control" placeholder="Ej: LOT-2025-001">
      </div>
      <div class="col-md-2">
        <label class="form-label"><i class="bi bi-exclamation-triangle"></i> Defectos</label>
        <input type="number" id="defectos" name="defectos" class="form-control" min="0" value="0">
      </div>
      <div class="col-md-4">
        <label class="form-label"><i class="bi bi-person-badge"></i> Inspector</label>
        <select id="inspector" name="inspector" class="form-select" required>
          <option value="">Seleccione un inspector</option>
          <option value="Mar√≠a L√≥pez">Mar√≠a L√≥pez</option>
          <option value="Carlos Ram√≠rez">Carlos Ram√≠rez</option>
          <option value="Ana Torres">Ana Torres</option>
          <option value="Pedro S√°nchez">Pedro S√°nchez</option>
        </select>
      </div>
      <div class="col-12">
        <label class="form-label">Comentarios Adicionales</label>
        <textarea id="comentarios" name="comentarios" class="form-control" rows="2" placeholder="Observaciones sobre el estado del producto..."></textarea>
      </div>
      <div class="col-12">
        <label class="form-label">Subir Archivos</label>
        <input type="file" class="form-control" accept="image/*">
        <small class="text-muted">Funcionalidad de subida de archivos pr√≥ximamente</small>
      </div>
    </div>
    <div class="mt-4">
      <button type="submit" class="btn btn-primary" id="btnSubmit"><i class="bi bi-save"></i> Guardar Registro</button>
      <button type="button" class="btn btn-secondary ms-2" onclick="cancelarEdicion()"><i class="bi bi-x-circle"></i> Cancelar</button>
    </div>
  </form>

  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4"><input type="text" id="buscar" class="form-control" placeholder="üîç Buscar producto..."></div>
      <div class="col-md-3"><select id="filtroCategoria" class="form-select"><option value="">Todas las categor√≠as</option></select></div>
      <div class="col-md-3"><select id="filtroEstado" class="form-select"><option value="">Todos los estados</option><option value="activo">Activos</option><option value="agotado">Agotados</option></select></div>
      <div class="col-md-2"><button class="btn btn-primary w-100" onclick="aplicarFiltros()"><i class="bi bi-funnel"></i> Filtrar</button></div>
    </div>
  </div>

  <h3 class="mb-3 fw-bold">Registros Guardados <span class="badge bg-primary" id="totalProductos">0</span></h3>

  <div class="loading" id="loading">
    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
    <p>Cargando productos...</p>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th><i class="bi bi-folder"></i> Categor√≠a</th>
          <th><i class="bi bi-box"></i> Producto</th>
          <th><i class="bi bi-building"></i> Proveedor</th>
          <th><i class="bi bi-calculator"></i> Cantidad</th>
          <th><i class="bi bi-calendar-check"></i> Recepci√≥n</th>
          <th><i class="bi bi-calendar-x"></i> Caducidad</th>
          <th><i class="bi bi-person-badge"></i> Inspector</th>
          <th><i class="bi bi-gear"></i> Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaRegistros">
        <tr><td colspan="8" class="text-center">No hay productos registrados</td></tr>
      </tbody>
    </table>
  </div>
</div>
</div>

<script>
const API_URL = 'http://localhost:3000';
let editandoId = null;

const proveedoresPorCategoria = {
  'Frutas': ['Frutas del Valle S.A.', 'Frutas Premium Ltda', 'Fruter√≠a La Cosecha', 'Agr√≠cola El Para√≠so'],
  'Granos': ['Diana - Arroz', 'Granos Premium', 'Molinos del Norte', 'Cereales Andinos'],
  'Verduras': ['Verduras Org√°nicas Ltda', 'Hortalizas del Campo', 'Vegetales Frescos', 'Granja Verde'],
  'Carnes': ['Av√≠cola del Norte', 'Carnes La Hacienda', 'Frigor√≠fico Central', 'Productos C√°rnicos Premium'],
  'L√°cteos': ['L√°cteos La Vaca', 'Alpina', 'Colanta', 'Alquer√≠a'],
  'Conservas': ['Conservas del Mar', 'Van Camp\'s', 'Isabel', 'Productos Enlatados S.A.'],
  'Bebidas': ['Bebidas Naturales', 'Jugos Hit', 'Postob√≥n', 'Coca-Cola Femsa'],
  'Congelados': ['Congelados Express', 'Frigor√≠fico del Norte', 'Mr. Freeze', 'Productos Congelados Premium'],
  'Panader√≠a': ['Panader√≠a La Especialidad', 'Pan Pa\' Ya', 'Bimbo', 'Productos de Panader√≠a Artesanal'],
  'Condimentos': ['McCormick', 'Brasilia', 'Knorr', 'Especias del Chef']
};

document.addEventListener('DOMContentLoaded', async () => {
  console.log('üçΩÔ∏è Isamaru Frontend iniciado');
  await cargarCategorias();
  await cargarUnidades();
  await cargarProductos();
  const form = document.getElementById('inventarioForm');
  form.addEventListener('submit', guardarProducto);
  const nombreInput = document.getElementById('nombre');
  nombreInput.addEventListener('input', function(e) {
    this.value = this.value.replace(/[0-9!@#$%^&*()_+=\[\]{};':"\\|,.<>\/?]/g, '');
    if (this.value && !/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(this.value)) {
      this.classList.add('is-invalid');
    } else {
      this.classList.remove('is-invalid');
    }
  });
  const hoy = new Date().toISOString().split('T')[0];
  document.getElementById('fecha_recepcion').value = hoy;
});

function actualizarProveedores() {
  const categoriaSelect = document.getElementById('categoria');
  const proveedorSelect = document.getElementById('proveedor');
  const categoriaNombre = categoriaSelect.options[categoriaSelect.selectedIndex]?.text;
  proveedorSelect.innerHTML = '<option value="">Seleccione un proveedor</option>';
  if (categoriaNombre && proveedoresPorCategoria[categoriaNombre]) {
    const proveedores = proveedoresPorCategoria[categoriaNombre];
    proveedores.forEach(proveedor => {
      const option = document.createElement('option');
      option.value = proveedor;
      option.textContent = proveedor;
      proveedorSelect.appendChild(option);
    });
    console.log(`‚úÖ ${proveedores.length} proveedores cargados para ${categoriaNombre}`);
  } else {
    proveedorSelect.innerHTML = '<option value="">Primero seleccione una categor√≠a</option>';
  }
}

async function cargarCategorias() {
  try {
    const response = await fetch(`${API_URL}/productos/categorias/lista`);
    const data = await response.json();
    if (data.success) {
      const select = document.getElementById('categoria');
      const filtroSelect = document.getElementById('filtroCategoria');
      select.innerHTML = '<option value="">Seleccione una categor√≠a</option>';
      filtroSelect.innerHTML = '<option value="">Todas las categor√≠as</option>';
      data.categorias.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id_categoria;
        option.textContent = cat.nombre;
        select.appendChild(option);
        const optionFiltro = option.cloneNode(true);
        filtroSelect.appendChild(optionFiltro);
      });
      console.log(`‚úÖ ${data.categorias.length} categor√≠as cargadas`);
    }
  } catch (error) {
    console.error('‚ùå Error cargando categor√≠as:', error);
    mostrarAlerta('Error al cargar categor√≠as', 'danger');
  }
}

async function cargarUnidades() {
  try {
    const response = await fetch(`${API_URL}/productos/unidades/lista`);
    const data = await response.json();
    if (data.success) {
      const select = document.getElementById('unidad');
      select.innerHTML = '';
      data.unidades.forEach(unidad => {
        const option = document.createElement('option');
        option.value = unidad.abreviatura;
        option.textContent = `${unidad.nombre} (${unidad.abreviatura})`;
        select.appendChild(option);
      });
      console.log(`‚úÖ ${data.unidades.length} unidades cargadas`);
    }
  } catch (error) {
    console.error('‚ùå Error cargando unidades:', error);
  }
}

async function cargarProductos(filtros = {}) {
  const loading = document.getElementById('loading');
  const tabla = document.getElementById('tablaRegistros');
  loading.classList.add('active');
  try {
    let url = `${API_URL}/productos`;
    const params = new URLSearchParams();
    if (filtros.categoria) params.append('categoria', filtros.categoria);
    if (filtros.estado) params.append('estado', filtros.estado);
    if (filtros.buscar) params.append('buscar', filtros.buscar);
    if (params.toString()) url += `?${params.toString()}`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.success) {
      mostrarProductosEnTabla(data.data);
      document.getElementById('totalProductos').textContent = data.count;
      console.log(`‚úÖ ${data.count} productos cargados`);
    }
  } catch (error) {
    console.error('‚ùå Error cargando productos:', error);
    tabla.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar productos</td></tr>';
    mostrarAlerta('Error al cargar productos del servidor', 'danger');
  } finally {
    loading.classList.remove('active');
  }
}

function mostrarProductosEnTabla(productos) {
  const tbody = document.getElementById('tablaRegistros');
  if (productos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay productos registrados</td></tr>';
    return;
  }
  tbody.innerHTML = '';
  productos.forEach(producto => {
    const tr = document.createElement('tr');
    let claseEstado = '';
    if (producto.estado_caducidad === 'Caducado') {
      claseEstado = 'caducado';
    } else if (producto.estado_caducidad === 'Por caducar') {
      claseEstado = 'por-caducar';
    }
    tr.innerHTML = `
      <td><span class="badge bg-info">${producto.categoria || '-'}</span></td>
      <td><strong>${producto.nombre}</strong></td>
      <td>${producto.proveedor || '-'}</td>
      <td><strong>${producto.cantidad}</strong> ${producto.unidad || ''}</td>
      <td>${formatearFecha(producto.fecha_recepcion)}</td>
      <td class="${claseEstado}">${formatearFecha(producto.fecha_caducidad)}</td>
      <td><small>${producto.inspector || '-'}</small></td>
      <td class="text-nowrap">
        <button class="btn btn-sm btn-info" onclick="verProducto(${producto.id_producto})" title="Ver detalles"><i class="bi bi-eye"></i></button>
        <button class="btn btn-sm btn-warning" onclick="editarProducto(${producto.id_producto})" title="Editar"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${producto.id_producto}, '${producto.nombre}')" title="Eliminar"><i class="bi bi-trash"></i></button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function guardarProducto(event) {
  event.preventDefault();
  const nombreInput = document.getElementById('nombre');
  if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(nombreInput.value)) {
    nombreInput.classList.add('is-invalid');
    mostrarAlerta('‚ùå El nombre del producto solo puede contener letras y espacios', 'danger');
    nombreInput.focus();
    return;
  }
  const btnSubmit = document.getElementById('btnSubmit');
  const textoOriginal = btnSubmit.innerHTML;
  btnSubmit.disabled = true;
  btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
  const formData = new FormData(event.target);
  const producto = {
    nombre: formData.get('nombre').trim(),
    proveedor: formData.get('proveedor') || null,
    id_categoria: parseInt(formData.get('categoria')),
    cantidad: parseFloat(formData.get('cantidad')),
    unidad: formData.get('unidad'),
    fecha_recepcion: formData.get('fecha_recepcion') || null,
    fecha_caducidad: formData.get('fecha_caducidad') || null,
    numero_lote: formData.get('numero_lote') || null,
    defectos: parseInt(formData.get('defectos') || 0),
    inspector: formData.get('inspector') || null,
    comentarios: formData.get('comentarios') || null
  };
  try {
    const esEdicion = editandoId !== null;
    const url = esEdicion ? `${API_URL}/productos/${editandoId}` : `${API_URL}/productos`;
    const method = esEdicion ? 'PUT' : 'POST';
    const response = await fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(producto)
    });
    const data = await response.json();
    if (data.success) {
      mostrarAlerta(esEdicion ? '‚úÖ Producto actualizado exitosamente' : '‚úÖ Producto creado exitosamente', 'success');
      event.target.reset();
      cancelarEdicion();
      await cargarProductos();
      document.getElementById('tablaRegistros').scrollIntoView({ behavior: 'smooth' });
    } else {
      mostrarAlerta('‚ùå ' + (data.error || 'Error al guardar el producto'), 'danger');
    }
  } catch (error) {
    console.error('‚ùå Error:', error);
    mostrarAlerta('‚ùå Error de conexi√≥n con el servidor', 'danger');
  } finally {
    btnSubmit.disabled = false;
    btnSubmit.innerHTML = textoOriginal;
  }
}

async function verProducto(id) {
  try {
    const response = await fetch(`${API_URL}/productos/${id}`);
    const data = await response.json();
    if (data.success) {
      const p = data.producto;
      
      let historialHTML = '';
      if (data.historial.length > 0) {
        historialHTML = '<div class="mt-3"><h6><i class="bi bi-clock-history"></i> Historial de Movimientos:</h6><ul class="list-unstyled">';
        data.historial.forEach(m => {
          const icono = m.tipo === 'entrada' ? 'üì•' : 'üì§';
          historialHTML += `<li class="mb-1">${icono} <strong>${m.tipo.toUpperCase()}</strong>: ${m.cantidad} ${p.unidad || ''} - <small>${formatearFecha(m.fecha)}</small></li>`;
        });
        historialHTML += '</ul></div>';
      } else {
        historialHTML = '<div class="alert alert-info mt-3">Sin movimientos registrados</div>';
      }

      let estadoColor = 'info';
      if (p.estado === 'agotado') estadoColor = 'danger';
      else if (p.estado === 'caducado') estadoColor = 'warning';

      Swal.fire({
        title: `üì¶ ${p.nombre}`,
        html: `
          <div class="text-start">
            <div class="row g-2">
              <div class="col-6">
                <small class="text-muted">üè¢ Proveedor:</small>
                <p class="mb-2"><strong>${p.proveedor || 'N/A'}</strong></p>
              </div>
              <div class="col-6">
                <small class="text-muted">üìÇ Categor√≠a:</small>
                <p class="mb-2"><strong>${p.categoria_nombre || 'N/A'}</strong></p>
              </div>
              <div class="col-6">
                <small class="text-muted">üìä Cantidad:</small>
                <p class="mb-2"><strong>${p.cantidad} ${p.unidad || ''}</strong></p>
              </div>
              <div class="col-6">
                <small class="text-muted">üìå Estado:</small>
                <p class="mb-2"><span class="badge bg-${estadoColor}">${p.estado}</span></p>
              </div>
              <div class="col-6">
                <small class="text-muted">üìÖ Recepci√≥n:</small>
                <p class="mb-2">${formatearFecha(p.fecha_recepcion)}</p>
              </div>
              <div class="col-6">
                <small class="text-muted">‚è∞ Caducidad:</small>
                <p class="mb-2">${formatearFecha(p.fecha_caducidad)}</p>
              </div>
              <div class="col-6">
                <small class="text-muted">üî¢ Lote:</small>
                <p class="mb-2">${p.numero_lote || 'N/A'}</p>
              </div>
              <div class="col-6">
                <small class="text-muted">‚ö†Ô∏è Defectos:</small>
                <p class="mb-2">${p.defectos}</p>
              </div>
              <div class="col-12">
                <small class="text-muted">üë§ Inspector:</small>
                <p class="mb-2">${p.inspector || 'N/A'}</p>
              </div>
              <div class="col-12">
                <small class="text-muted">üí¨ Comentarios:</small>
                <p class="mb-2">${p.comentarios || 'Sin comentarios'}</p>
              </div>
            </div>
            ${historialHTML}
          </div>
        `,
        icon: 'info',
        width: '600px',
        confirmButtonText: 'Cerrar',
        confirmButtonColor: '#41D0E7',
        showClass: {
          popup: 'animate__animated animate__fadeInDown'
        },
        hideClass: {
          popup: 'animate__animated animate__fadeOutUp'
        }
      });
    }
  } catch (error) {
    console.error('‚ùå Error:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo obtener los detalles del producto',
      confirmButtonColor: '#41D0E7'
    });
  }
}

async function editarProducto(id) {
  try {
    const response = await fetch(`${API_URL}/productos/${id}`);
    const data = await response.json();
    if (data.success) {
      const p = data.producto;
      document.getElementById('nombre').value = p.nombre;
      document.getElementById('categoria').value = p.id_categoria;
      actualizarProveedores();
      setTimeout(() => {
        document.getElementById('proveedor').value = p.proveedor || '';
      }, 100);
      document.getElementById('cantidad').value = p.cantidad;
      document.getElementById('unidad').value = p.unidad || '';
      document.getElementById('fecha_recepcion').value = p.fecha_recepcion?.split('T')[0] || '';
      document.getElementById('fecha_caducidad').value = p.fecha_caducidad?.split('T')[0] || '';
      document.getElementById('numero_lote').value = p.numero_lote || '';
      document.getElementById('defectos').value = p.defectos || 0;
      document.getElementById('inspector').value = p.inspector || '';
      document.getElementById('comentarios').value = p.comentarios || '';
      editandoId = id;
      const btnSubmit = document.getElementById('btnSubmit');
      btnSubmit.innerHTML = '<i class="bi bi-pencil"></i> Actualizar Producto';
      btnSubmit.classList.remove('btn-primary');
      btnSubmit.classList.add('btn-warning');
      document.getElementById('inventarioForm').scrollIntoView({ behavior: 'smooth' });
      mostrarAlerta('Editando producto. Realiza los cambios y haz clic en Actualizar.', 'info');
    }
  } catch (error) {
    console.error('‚ùå Error:', error);
    mostrarAlerta('Error al cargar el producto', 'danger');
  }
}

function cancelarEdicion() {
  editandoId = null;
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.innerHTML = '<i class="bi bi-save"></i> Guardar Registro';
  btnSubmit.classList.remove('btn-warning');
  btnSubmit.classList.add('btn-primary');
  document.getElementById('inventarioForm').reset();
  const hoy = new Date().toISOString().split('T')[0];
  document.getElementById('fecha_recepcion').value = hoy;
}

async function eliminarProducto(id, nombre) {
  const result = await Swal.fire({
    title: '¬øEst√°s seguro?',
    html: `Se eliminar√° el producto:<br><strong>${nombre}</strong>`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar',
    reverseButtons: true
  });

  if (result.isConfirmed) {
    try {
      const response = await fetch(`${API_URL}/productos/${id}`, { method: 'DELETE' });
      const data = await response.json();
      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: '¬°Eliminado!',
          text: 'El producto ha sido eliminado exitosamente',
          confirmButtonColor: '#41D0E7',
          timer: 2000
        });
        await cargarProductos();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.error || 'No se pudo eliminar el producto',
          confirmButtonColor: '#41D0E7'
        });
      }
    } catch (error) {
      console.error('‚ùå Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error de conexi√≥n',
        text: 'No se pudo conectar con el servidor',
        confirmButtonColor: '#41D0E7'
      });
    }
  }
}

function aplicarFiltros() {
  const buscar = document.getElementById('buscar').value;
  const categoria = document.getElementById('filtroCategoria').value;
  const estado = document.getElementById('filtroEstado').value;
  const categoriaTexto = categoria ? document.querySelector(`#filtroCategoria option[value="${categoria}"]`).textContent : null;
  cargarProductos({ buscar, categoria: categoriaTexto, estado });
}

document.getElementById('buscar')?.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') aplicarFiltros();
});

function formatearFecha(fecha) {
  if (!fecha) return '-';
  const d = new Date(fecha);
  return d.toLocaleDateString('es-CO', { year: 'numeric', month: '2-digit', day: '2-digit' });
}

function mostrarAlerta(mensaje, tipo = 'info') {
  let icono = 'info';
  let titulo = 'Informaci√≥n';
  
  if (tipo === 'success') {
    icono = 'success';
    titulo = '¬°√âxito!';
  } else if (tipo === 'danger' || tipo === 'error') {
    icono = 'error';
    titulo = 'Error';
  } else if (tipo === 'warning') {
    icono = 'warning';
    titulo = 'Advertencia';
  }

  Swal.fire({
    icon: icono,
    title: titulo,
    text: mensaje.replace(/‚úÖ|‚ùå|‚ö†Ô∏è/g, '').trim(),
    confirmButtonColor: '#41D0E7',
    timer: tipo === 'success' ? 2500 : undefined,
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timerProgressBar: true
  });
}

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>